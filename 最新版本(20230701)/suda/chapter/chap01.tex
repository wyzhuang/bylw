\chapter{绪论}
\label{chap:chap01}

\section{研究背景及意义}

随着软件规模的不断扩大和软件组件的日益复杂，软件质量保障变得至关重要，而如何识别软件中的缺陷是软件质量保证的重要一环。软件缺陷是指计算机程序或系统中的错误、缺陷、bug或故障，可能会产生不准确或意外的结果，或使软件无法按预期运行。软件缺陷对软件质量的影响极大，每年都有很多因为软件缺陷而造成的事故，往往给公司及政府带来严重的经济损失。由于测试资源（人员、时间、金钱等）有限，对软件进行详细完备的测试通常很难做到。因此，软件缺陷预测技术应运而生，它能在项目开发的早期阶段，帮助开发人员和测试人员识别哪些模块更具有缺陷倾向性，从而让他们能更加合理地分配测试资源，更加快速地定位缺陷，并识别常规测试难以发现的缺陷。

软件缺陷预测技术能够帮助合理分配测试资源。由于缺陷在软件各个部分中的分布是不同的，因此对软件系统的所有部分应用相同的测试工作并不是最佳方法。因此，通过软件缺陷预测技术，对缺陷倾向性更高的模块投入更多的测试资源，在实际开发中可以降低开发和测试成本。相关研究\cite{DBLP:journals/tse/MondenHSSYBM13}对软件缺陷预测技术对项目的实际贡献进行评估，发现公司需要大约6\%的测试工作量来收集指标、清理数据和建模，却可以减少25\%的测试工作量。除此之外，那些使用传统测试方法所能发现的缺陷也可以被缺陷预测模型所识别。

软件缺陷预测技术能够在项目开发的早期阶段识别缺陷。在项目开发生命周期中，越早发现缺陷，修复缺陷所需的成本越低\cite{DBLP:conf/issre/SmidtsSS96}。因此，软件缺陷预测技术被用在项目开发过程中来迅速地识别软件模块的缺陷倾向性，从而改善软件设计，有效避免在软件构建完成后再花费大代价去改正缺陷的风险。相关调查\cite{DBLP:journals/tse/HallBBGC12}综合了36项研究的定量和定性结果，认为软件缺陷预测技术可以有效减少最终软件系统的缺陷数量，从而提高软件质量。一些研究人员不满足于仅在开发阶段构建缺陷预测模型，为了减少修复缺陷的成本，他们选择在需求分析和概要设计阶段建立缺陷预测模型，同样发现缺陷预测技术有助于在项目早期阶段识别缺陷\cite{DBLP:conf/icse/ShrikanthMM21,DBLP:journals/jss/OzakinciT18}。

软件缺陷预测技术能够识别常规测试难以发现的缺陷。不同于传统的白盒测试和黑盒测试，软件缺陷预测技术利用缺陷之间的相似性来识别模块存在缺陷的风险。缺陷预测技术可以指导测试人员从其他角度寻找软件系统的潜在缺陷，对于软件质量保证有着积极的促进作用。

即时软件缺陷预测是软件缺陷预测中的一个子领域，它面向实际的项目开发工作环境，关注开发人员的某次提交所引起的变更会不会引入缺陷。由于现代软件开发是协作和敏捷的，具有持续交付和持续部署等流行趋势，旨在以更高的速度和频率构建、修复和发布软件，所以即时软件缺陷预测面向的软件变更集通常较小，开发人员可能也只需要较少的精力就能对变更集进行审查。因此，近年来即时软件缺陷预测技术越来越受到研究人员的重视~\cite{lxt2023, DBLP:journals/csur/ZhaoDC23}。

\section{研究现状}

软件缺陷预测模型识别软件系统中容易出现缺陷的实体(例如，文件、包、类和函数)。准确的预测模型有助于开发人员专注于检查可能有缺陷的模块，并有效地利用他们的时间和精力，因此引起了很多研究者的关注。本节将先介绍软件缺陷预测各个环节的国内外研究现状，然后介绍一下软件缺陷预测领域中数据预处理方法相关研究。

\subsection{软件缺陷预测}
软件缺陷预测技术一般分为以下四步：(1)构建数据集；(2)设计软件特征；(3)构建分类模型；(4)评估模型性能。因此，相关研究也往往集中于以上四个方面。

(1)构建数据集

软件缺陷技术通常需要软件故障信息库所提供的信息，这些信息被模型学习并预测当前开发的软件项目中的缺陷倾向性。软件故障数据集主要有三组信息：软件度量集、缺陷信息(模块是否有缺陷，缺陷模块含有缺陷的数量等)，以及关于软件项目的元信息(如提交信息)。目前，缺陷预测领域有一些公共数据集，比如PROMISE，NASA等，帮助相关研究者构建缺陷预测模型。

然而，这些数据集往往面临类不平衡问题\cite{DBLP:journals/tr/WangY13}，具体来说，数据集中有缺陷的模块少，而无缺陷的模块多，这容易误导预测模型，降低模型的实际预测性能。因此，软件缺陷领域研究者也应用各种类再平衡技术\cite{DBLP:journals/tr/WangY13,DBLP:journals/symmetry/BejjankiGG20,DBLP:conf/icse/TanTDM15,DBLP:journals/tse/SongGS19}，希望可以缓解这个问题。其中，Song等人\cite{DBLP:journals/tse/SongGS19}为了解决以前研究在不同数据集上结果的矛盾问题，进行了大规模的实验。他们选择了17种流行的类再平衡技术，在27个数据集，7种特征和7种分类器上进行综合性的实验。结果表明不平衡问题越严重的数据集越能受到类再平衡技术的积极影响，但是如果不做任何考虑，随便地采用类再平衡技术，那么可能只会产生非常小的积极影响。


(2)设计软件特征

如何寻找软件缺陷，研究人员认为软件模块具有各式各样的特征，利用软件模块的这些特征可以区分有缺陷的模块和无缺陷的模块，因此软件特征至关重要。从特征生成的不同角度出发，我们可以将特征分为手工特征和语义特征。

手工特征指研究人员根据缺陷模块与无缺陷模块之间的差别，人为制定某种特征。例如，为了描述代码的复杂度而提出的McCabe度量\cite{DBLP:journals/tse/McCabe76}，基于面向对象程序的CK度量\cite{DBLP:journals/tse/ChidamberK94}等。除了这些静态代码度量，还有一些面向代码更改的过程度量。例如Nagappan与Ball\cite{DBLP:conf/icse/NagappanB05}用相对代码变化作为度量，得到了比绝对代码变化更好的效果。在即时软件缺陷预测领域，Mockus和Weiss\cite{DBLP:journals/bell/MockusW00}提出了14种更改级别的度量，可以有效描述每次提交代码的变化。除此之外，也有研究人员将目光投入到开发者身上，如Nucci等人\cite{DBLP:journals/tse/NucciPRBOL18}认为专注的开发人员比非专注的开发人员更不容易引入缺陷，基于此引入分散更改作为特征，也能有效识别有缺陷的模块。

语义特征是近些年来兴起的提取特征方式，基于代码本身，更加直观地描述软件模块。Wang等人\cite{DBLP:journals/tse/WangLNT20}提出基于代码令牌的缺陷预测模型，他们通过在文件级别和更改级别，以及项目内和跨项目场景下的大规模实验，验证了语义特征的有效性。在此基础上，Wang等人\cite{DBLP:journals/tr/WangZZ21}用代码的AST序列来表示代码的结构信息，并利用门控机制将语义特征和传统手工特征相结合，取得了更优越的效果。随着图神经网络的提出，Xu等人\cite{DBLP:journals/tr/XuWA21}保留了代码的AST树形结构，用图神经网络捕捉缺陷子树的潜在缺陷信息并进行剪枝，取得了优于传统方法的结果。在过程度量方面，Wen等人\cite{DBLP:journals/tse/WenWC20}通过细粒度的变更分析来提取六种类型的变更序列，利用软件演化过程中由变更产生的顺序信息识别缺陷。在即时软件缺陷预测领域，Pornprasit等人\cite{DBLP:conf/msr/PornprasitT21}基于代码的令牌向量提出了一种快速模型，并能将缺陷定位到代码行。

(3)构建分类模型

为了学习软件模块的特征和预测模块是否有缺陷，研究人员需要挑选合适的分类模型。在软件缺陷预测领域，主要采用机器学习方法来构建预测模型。

Menzies等人\cite{DBLP:journals/ase/MenziesMTCJB10}进行了一项实验研究，以评估朴素贝叶斯与对数滤波器在软件故障预测中的性能，结果表明，所使用的技术在软件故障预测中表现出显著的准确性。随着深度学习的流行，相关研究者开始探究如何将深度学习与缺陷预测相结合\cite{DBLP:conf/icse/OmriS20,DBLP:journals/sp/LiuWW21a,DBLP:conf/iccsa/KumarDNSMKP21}。Yang等人\cite{DBLP:conf/qrs/YangLXZS15}用深度置信网络对特征进行再训练，然后用线性回归进行预测，把深度学习用于软件缺陷预测领域中。Fan等人\cite{DBLP:journals/sp/FanDYYC19}采取注意力机制，学习特征中对模型贡献较大的部分，并用循环神经网络进行训练和预测。Zhou等人\cite{DBLP:conf/nips/ZhouLSD019}利用门控图神经网络，结合代码的AST树，控制流图，数据流图等信息，提高模型识别漏洞的能力。 Zhu等人\cite{DBLP:journals/iet-sen/ZhuZYZ20}将在项目内和跨项目的场景下，利用去噪自编码器对特征进行去噪，接着用卷积神经网络收集特征的局部信息，成功提高了模型的性能。Tong等人\cite{DBLP:journals/tse/TongLW21}在异构缺陷预测领域上，结合核谱嵌入、转移学习和集成学习，找到源和目标数据集的潜在公共特征空间，提高模型的性能。

(4)评估模型性能

在模型对软件系统中可能存在的缺陷做出预测后，研究人员需要对模型的性能做出评估，因此设计了一系列的评估指标。在软件缺陷预测领域，评估指标主要有两类\cite{gln2019}，一类是非工作量感知评估指标，一类是工作量感知指标。

非工作量感知指标主要是传统的评估机器学习模型的相关指标，比如准确度、精确度、召回率、F1\cite{DBLP:journals/ese/JiangCM08}和MCC\cite{DBLP:journals/bioinformatics/BaldiBCAN00}等，这些指标被广泛应用于软件缺陷预测的相关研究中 \cite{DBLP:conf/icse/JingYZWL14,DBLP:journals/tse/MenziesGF07,DBLP:journals/tosem/ZhouYLCLZQX18,DBLP:journals/ijseke/ChenSW21}。

工作量感知指标则注重测试人员检查缺陷所需要的工作量\cite{DBLP:conf/sigsoft/ZhangC13}。这是因为非工作量感知对于所有软件模块都一视同仁，但是不同的软件模块复杂程度不同，检查所需的工作量也不相同。因此，相关研究人员\cite{DBLP:conf/csmr/MendeK10}提出用代码行和模型预测的概率值来决定测试人员应该先检测哪个模块。由此，研究者设计了一系列相关的工作量感知指标。Jiang等人 \cite{DBLP:conf/kbse/JiangTK13}提出了PofB20，这个指标用于衡量当检查总代码行的前20\%时，所能发现的缺陷比例；Huang等人\cite{DBLP:conf/icsm/HuangXL17}提 出了IFA，这个指标代表测试人员找到第一个缺陷时所审查的模块数，并报告当IFA过高时，测试人员将丧失对预测模型的信心。 Mende等人\cite{DBLP:conf/promise/MendeK09}提出了$P_{opt}$，这个指标当被用于按照缺陷概率密度排序时，衡量预测模型与理想模型之间的相似度。

除了以上四个主要内容，相关研究者还从其他角度对缺陷预测技术进行研究。比如McIntosh等人\cite{DBLP:journals/tse/McIntoshK18}对构建模型所用数据的时间进行研究，认为项目早期的数据可能会误导预测模型，建议每三到六个月重新构建预测模型。Li等人\cite{DBLP:conf/icse/LiX0WT20}对跨项目上缺陷预测模型的参数优化进行研究，发现自动参数优化可以显著提高了缺陷预测技术的性能。Pornprasit等人\cite{DBLP:conf/kbse/PornprasitTJFT21}基于局部规则的模型不可知技术，对缺陷预测模型的解释做出探索。

虽然在软件缺陷预测领域中的研究已经较为充分了，但是相关研究人员很少在意项目中所产生的样本的时间顺序关系，这些时间顺序关系可能也会对模型造成一部分的影响。例如，目前很多研究工作\cite{DBLP:conf/msr/HoangDK0U19,DBLP:journals/ese/HuangXL19,kamei2016studying,DBLP:conf/qrs/TianLTZ20}采用K-折交叉验证的方式来衡量模型性能，但是在实际环境下，测试人员只能依靠项目早期的样本来预测项目晚期的样本，这样会导致报告的性能与模型的实际性能有所偏差。虽然有部分研究工作\cite{DBLP:journals/tse/McIntoshK18}指出样本的时间标签的重要性，但是如何利用时间维度来增强预测模型性能的相关方向尚未得到充分研究。此外，由于不同样本的质量不一样，会存在一些让预测模型难以正确分类的样本，如何加强模型对难分类样本的关注也需要进一步的研究。因此，本文通过对样本施加重要性权重，希望通过利用样本的时间维度和误分类样本的特征贡献度，来提高模型的预测性能。

\subsection{数据预处理技术}
在软件缺陷预测领域，数据预处理主要关注原始特征被提取之后到输入模型之前的这个阶段，对于特征来言，由于不同特征存在某些相关性或者是量纲的偏差，导致模型不能很好地进行学习；对于样本实例来言，可能存在噪声或者类不平衡，导致模型学习的精度降低，需要对样本进行采样。围绕上述两个问题，相关研究可能分为基于列的数据预处理技术和基于行的数据预处理技术。

(1)基于列的数据预处理技术

基于列的方法主要关注特征倾斜，特征共线和特征选择的问题。在特征倾斜方向，相关技术主要通过一些变换函数，对特征数据进行处理，防止某个维度的数据与其他维度数据在量纲上差距过大，使得模型学习出现偏差。比如Duan等人~\cite{DBLP:journals/tr/DuanXFY22}用标准对数变换 ln(x+1)用于每个度量，为其在八个Apache开源项目的105828个变更进行的实证研究提供了坚实基础。

特征共线方向，相关技术主要通过分析不同特征之间的关联程度，防止模型对某个单独特征产生误解。比如Fan等人~\cite{DBLP:journals/tse/FanXCLHL21}对10个Apache开源项目的126526个变更进行大规模实证研究，认为对于两个相关变量应该保留有助于简化模型解释的变量。对于特征倾斜和特征共线问题，目前的研究工作主要集中在实证研究上。

特征选择技术用来选取最重要的特征，减少特征维度，防止维度灾难问题，从而提高预测模型的性能。Chen等人~\cite{DBLP:journals/jzusc/ChenWCXCC22}提出了一种基于特征选择和迁移学习的具有度量补偿的软件缺陷预测方法，有效缓解了跨项目缺陷预测上的数据分布差异过大的问题。Awotunde等人~\cite{DBLP:conf/iccsa/AwotundeMAMKL22}为了解决检测时间长、软件项目的脆弱性和特征参数的高维性等问题，提出了一种混合模型，使用数据归一化方法处理数据集不平衡和特征冗余的情况，采用支持特征选择的极限梯度增强分类器，提高了预测模型的性能。Bala等人~\cite{DBLP:journals/access/BalaSSM23}提出了一种变换和特征选择方法，使用源项目的平均分布特征和模式分布特征，从标准偏差的三倍计算变换源的每个特征的距离，以减少跨项目缺陷预测中的分布差异和高维特征问题。


(2) 基于行的数据预处理技术

在基于行的数据预处理技术，采样方法是一种比较流行的策略方法，在该策略方法中，在模型构建之前重新平衡数据分布，以便学习的分类器可以以类似于传统分类的方式执行，采样方法独立于预测模型，易于观察，并忠实代表了研究对象的性质，主要分为欠采样和过采样两种途径。

欠采样通过消除大多数类样本来提取原始数据的子集，但主要缺点是这可能会丢弃潜在的有用数据。传统的随机欠采样方法 (Random Under-sampling, RUS) 就是随机从多数类中挑选一部分样本，将它们从数据集中删去，保持数据集不同类的平衡，这种做法很容易丢失有效信息，导致模型欠拟合。一些研究者关注多数类的噪声问题，比如Wu等人~\cite{2020LIMCR}提出了一种基于朴素贝叶斯的重采样方法，该方法评估多数类中每个样本的信息程度后，去除信息较少的多数类样本，以重新平衡数据分布。但是这种做法仍然会可能存在过度去除噪声，导致有效信息被丢失的问题。

过采样通过生成一些少数类样本来创建原始数据的超集，然而，这可能会增加过拟合的可能性。随机过采样 (Random Over-sampling, ROS) 方法随机复制属于少数类的样本，是过采样技术的最简单形式。然而，ROS只复制现有的少数类样本，这意味着它没有为分类器学习提供新的信息，因此可能导致预测模型的过拟合。合成少数类过采样 (Synthetic Minority Over-sampling Technique，SMOTE)方法~\cite{DBLP:journals/jair/ChawlaBHK02}通过将某个少数类样本与先前定义的少数类最近邻样本相结合来生成新合成样本。因为SMOTE通过组合而不是复制样本来生成合成样本，所以它生成的样本比ROS更多样，但是仍然未能解决模型过拟合的问题。为了解决过拟合问题，相关研究者也做了很多工作，比如Bennin等人\cite{DBLP:journals/tse/BenninKPMM18}为了增强数据集的多样性，结合染色体配对思想，提出匹配最远缺陷特征点来生成新数据的MAHAKIL方法。Agrawal等人\cite{DBLP:conf/icse/AgrawalM18}在更大规模的数据集上，使用基于SMOTE的改良方法，利用差分进化算法自动确定参数，也获得了很好的效果。在此基础上，Feng等人\cite{DBLP:journals/infsof/FengKYXBKZ21}通过差分进化算法确定特征的权重，并将样本根据复杂度排序来生成新的样本，在保留数据的多样性的前提下，获得了更好的效果。

上述采样方法虽然已经从数据集的不同角度出发，获得了一定的效果，但是仍然存在一些可改进的问题，比如SMOTE方法生成样本太过近似，容易让模型过拟合；Bennin等人的方法生成的样本太过多样，容易混淆多数类样本和少数类样本；Feng等人的方法将样本的复杂程度等同于样本的重要程度，这并不十分直接。因此本文基于两种样本重要性权重，拉近重要样本的距离来合成新的样本，可以有效缓解以前研究的问题。


\section{研究内容}

虽然相关研究\cite{DBLP:journals/tse/McIntoshK18}已经指出，对整个项目开发周期来言，用项目早期数据所构建的预测模型不能很好地预测项目晚期的模块是否具有缺陷，并且建议三到六个月就重新构建预测模型。但是目前仍然缺乏对于如何重新构建预测模型的研究，即如何平衡项目早期数据和新产生的数据，如何处理相近时间下的难分类样本，以及如何处理类不平衡问题。

本文将在更大的数据集上对相关研究\cite{DBLP:journals/tse/McIntoshK18}的观点进行验证，并基于以上三个问题进行进一步的研究。具体地，本文基于模型迭代的场景下，设计了两种样本重要性权重和一种基于样本权重的数据采样方法，来进一步提高预测模型的性能。具体研究内容结构如图~\ref{chap01_fig_framework}所示。

\begin{figure}[!h]
	\centering
	\includegraphics[width=0.9\textwidth]{../fig/chp1/framework.pdf}
	\smallcaption{本文的研究内容结构}
	\label{chap01_fig_framework}
\end{figure}

\subsection{基于时间维度的样本重要性权重}

在项目实际开发环境下，项目的故障数据库中存在一部分已经打好标签的历史数据，测试人员可以根据这些历史数据来构建缺陷预测模型，对新产生的样本进行预测。但是项目的开发周期很长，使用早期历史数据构建的预测模型往往不能准确判断项目晚期新产生的提交是否具有缺陷\cite{DBLP:conf/msr/EkanayakeTGB09}。此外，不同于其他领域，软件项目开发过程中所产生的样本具有时间顺序，在实际环境下，只能拿项目早期的样本来训练模型，以预测项目晚期的样本。并且，样本的这种时间标签对模型的性能也具有影响。相关实证研究\cite{DBLP:journals/tse/McIntoshK18}指出，项目早期的数据可能会对模型产生误导，而最近新打上标签的数据对于模型性能有着积极影响。

为了充分利用提交序列的时间维度，让模型更多关注时间较新的提交，本文基于项目开发过程中缺陷预测模型不断迭代的场景下，提出一种基于时间维度的样本重要性权重(Time-based Weights, TBW)。该方法在数据预处理阶段，通过时间衰减函数，给新旧提交施加不同的权重，来使模型更关注新打上标签的样本。


\subsection{基于特征贡献度的样本重要性权重}

在软件工程领域中，由于实际开发环境的复杂性，所产生的不同样本质量参差不齐，重要程度也各不相同。比如，代码行变动大的样本一般都含有缺陷，如果模型过多关注这些样本，很容易陷入仅用代码行的变动大小对样本做出预测，所以需要对多维特征进行综合考虑。此外，一些提交样本很容易被误分类，这类样本被称为难分类样本，需要模型给予更多的关注。因此，本文通过对样本施加另外的权重，让模型关注价值更高的样本。

为了区别时间相近的提交，以及让模型准确识别容易被误分类的样本，本文提出了一种基于特征贡献度的样本重要性权重(Contribution-based Weights, CBW)。该方法分为两个阶段，一阶段根据上一轮模型迭代所产生的预测标签和真实标签之间的差异，对被误分类的样本设置更高的权重；二阶段针对被误分类的样本，通过机器学习解释模型计算样本的特征贡献度和分类倾向性，根据分类倾向性来对与真实标签差异更大的样本施加更高的权重，最后还进行了去噪处理，从而有效提高预测模型的性能。



\subsection{基于样本重要性权重的过采样方法}
目前，在软件缺陷预测领域，存在较为严重的类不平衡问题。根据Pareto法则，80\%的缺陷往往集中于20\%的软件模块中，因此如何缓解类不平衡问题也是缺陷预测研究的一项重点内容。考虑到多样的数据能使得模型更能准确地识别不同阶段的样本，而传统的数据合成采样方法(如SMOTE)有以下几个方面的问题：第一，挑选中心样本过于随机，可能会挑选到噪声样本；第二，总是与最近邻样本合成新的样本数据，使得生成的数据太过近似，可能会导致模型过拟合，影响预测模型的性能；第三，对所有特征维度同等看待，不能反映不同特征的重要程度。

为了缓解上述三个方面的问题，本文提出了一种基于样本重要性权重的数据采样方法(Weight-base  Oversampling, WBO)。该方法通过样本重要性权重来挑选中心样本，用扩增的特征矩阵来计算近邻样本，来合成新样本。该方法有以下三个方面的好处：首先，通过计算每个样本的两个权重来对样本的重要程度进行排序，只保留部分最重要的样本作为中心样本，这些样本更具有代表性；其次，通过连接样本的特征向量和权重的方式，拉近重要样本之间的距离，使得合成的数据更加多样化，从而有效提高预测模型的性能；最后，样本重要性权重有一部分是通过计算特征贡献度得到的，能够反映不同特征的重要程度。


\section{论文组织结构}

本文全文共六章，结构组织如下： 

第一章简要介绍了软件缺陷预测技术研究背景以及意义，相关研究现状以及本文的主要研究内容。

第二章系统介绍了目前即时软件缺陷预测领域相关的背景知识。

第三章介绍了一种基于时间维度的样本重要性权重。该方法从项目的版本控制系统中提取时间维度信息，然后利用时间衰减函数赋予新提交的样本较高权重，旧提交的样本较低权重，针对性地提高缺陷预测的性能，在预测模型迭代的场景下，针对10个开源项目，每个项目挑选5个数据区间，9次迭代过程，共450个任务上进行了实验，验证了该样本权重的有效性。 

第四章介绍了一种基于特征贡献度的样本重要性权重。该方法针对上一轮模型迭代过程中被误分类的提交样本，通过机器模型解释框架计算它们的特征贡献度和分类倾向性，对分类倾向性与实际类别偏差较大的提交赋予较高的权重，最后还进行去噪处理。本章进行了详尽的实验来验证该方法的性能表现。

第五章介绍了一种基于样本重要性权重的数据采样方法。该方法一方面通过样本重要性权重对提交样本进行排序，挑选重要的样本用于合成新样本；另一方面计算样本距离时也会考虑样本重要性权重，合成的样本更具有多样性，从而有效提高预测模型的性能。

第六章主要总结了本文所做的即时软件缺陷预测中基于样本权重的数据预处理方法研究的具体贡献，并就相关研究的进一步实施进行了展望。
